<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="allofus">
<title>Extracting All of Us survey and EHR data • allofus</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Extracting All of Us survey and EHR data">
<meta property="og:description" content="allofus">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-black"><div class="container">
    <div style="height:40px;display:inline;margin:0 10px;"><a href="https://ohdsi.northeastern.edu/" class="external-link"><img src="https://roux-ohdsi.github.io/allofus/articles/logo.png" style="width:auto;height:100%;"></a></div>
    <a class="navbar-brand me-2" href="../index.html">allofus</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/allofus.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/workspace.html">Managing files on the workbench</a>
    <a class="dropdown-item" href="../articles/data.html">Extracting All of Us survey and EHR data</a>
    <a class="dropdown-item" href="../articles/atlas.html">Using ATLAS to create a cohort</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Codebooks</h6>
    <a class="dropdown-item" href="../articles/web_only/searchable_codebook.html">All of Us Surveys</a>
    <a class="dropdown-item" href="../articles/web_only/health_codebook.html">Health History Surveys</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/roux-ohdsi/allofus/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Extracting All of Us survey and EHR data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/roux-ohdsi/allofus/blob/HEAD/vignettes/data.Rmd" class="external-link"><code>vignettes/data.Rmd</code></a></small>
      <div class="d-none name"><code>data.Rmd</code></div>
    </div>

    
    
<p>The <a href="https://workbench.researchallofus.org/" class="external-link">Researcher
Workbench</a>, available to registered All of Us researchers, provides
tools for creating datasets using the All of Us database. Researchers
first use the Workbench to create a cohort defined by values of survey
variables (e.g., gender, race, age), observations from the electronic
health record (e.g., diagnosis codes, lab values), data from wearable
devices (e.g., fitbit), genomic data, and/or physical measurements. Data
– either predefined or user-specified <a href="https://www.researchallofus.org/faq/what-is-a-concept-set/" class="external-link"><em>concept
sets</em></a> – from each of the database tables can then be extracted
for the cohort.</p>
<!-- More information on this process is available [here](https://support.researchallofus.org/hc/en-us/articles/4556645124244-Using-the-Concept-Set-Selector-and-Dataset-Builder-tools-to-build-your-dataset). -->
<p>The <code>allofus</code> package takes a programmatic approach to
extracting data from the All of Us database. One advantage to this
approach is that it is easier to document and share the process. This is
especially important for reproducibility and transparency. To
demonstrate, this vignette will walk through some examples of extracting
data from the All of Us database.</p>
<p>Suppose we want a cohort of the female All of Us participants who
weren’t born in the US. For this cohort, we want to extract data on
their history of diabetes, their A1C lab values, and their use of
metformin after joining All of Us.</p>
<div class="section level2">
<h2 id="survey-data">Survey data<a class="anchor" aria-label="anchor" href="#survey-data"></a>
</h2>
<p>The first step is extracting gender and country of birth from the
survey data. We can retrieve these variables either by concept code or
concept id. Using the <code>allofus</code> <a href="https://roux-ohdsi.github.io/allofus/articles/web_only/searchable_codebook.html" class="external-link">searchable
codebook</a>, we find that the concept id for gender is 1585838 and for
birthplace is 1586135. We can use the <code>aou_survey</code> function
to extract these variables from the All of Us database. This function
takes a vector of concept ids or codes, and returns a dataset with one
row per participant and one column per variable. The
<code>question_output</code> argument allows you to specify the names of
the column in the output dataset. Alternatively, you can specify
“concept_id” or “concept_code” to name the variables according to one of
those options.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/allofus/" class="external-link">allofus</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">svy_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aou_survey.html">aou_survey</a></span><span class="op">(</span>questions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1585838</span>, <span class="fl">1586135</span><span class="op">)</span>, question_output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gender"</span>, <span class="st">"birthplace"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Warning: No cohort provided.</span></span>
<span><span class="co">#&gt; → Pulling survey data for entire All of Us cohort.</span></span></code></pre>
<p>Note that the <code>aou_survey</code> function takes a cohort as an
argument, with the only requirement that it contains a column called
<code>person_id</code>. If no cohort is provided (e.g., if you are using
survey data to define your cohort), the function will pull data for the
entire All of Us cohort.</p>
<p>Because <code><a href="../reference/aou_survey.html">aou_survey()</a></code> defaults to
<code>collect = FALSE</code>, the query isn’t fully executed yet, and we
can continue to perform analyses, like cross-tabulating the two
variables, on the database.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">svy_vars</span>, <span class="va">gender</span>, <span class="va">birthplace</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # Source:   SQL [?? x 3]</span></span>
<span><span class="co">#&gt; # Database: BigQueryConnection</span></span>
<span><span class="co">#&gt;    gender            birthplace       n</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;             &lt;chr&gt;      &lt;int64&gt;</span></span>
<span><span class="co">#&gt;  1 Skip              Skip          4449</span></span>
<span><span class="co">#&gt;  2 NA                NA              97</span></span>
<span><span class="co">#&gt;  3 Woman             USA         205440</span></span>
<span><span class="co">#&gt;  4 Woman             Other        40348</span></span>
<span><span class="co">#&gt;  5 Man               Skip          1484</span></span>
<span><span class="co">#&gt;  6 Transgender       USA            504</span></span>
<span><span class="co">#&gt;  7 PreferNotToAnswer USA            475</span></span>
<span><span class="co">#&gt;  8 PreferNotToAnswer Other          112</span></span>
<span><span class="co">#&gt;  9 Man               USA         131698</span></span>
<span><span class="co">#&gt; 10 Man               Other        21059</span></span>
<span><span class="co">#&gt; # ℹ more rows</span></span></code></pre>
<p>To create our cohort, we can subset the data to the participants
matching our criteria.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohort</span> <span class="op">&lt;-</span> <span class="va">svy_vars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"Woman"</span>, <span class="va">birthplace</span> <span class="op">==</span> <span class="st">"Other"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohort</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # Source:   SQL [?? x 5]</span></span>
<span><span class="co">#&gt; # Database: BigQueryConnection</span></span>
<span><span class="co">#&gt;    person_id birthplace gender birthplace_date gender_date</span></span>
<span><span class="co">#&gt;      &lt;int64&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;date&gt;          &lt;date&gt;     </span></span>
<span><span class="co">#&gt;  1   xxxxxxx Other      Woman  2019-08-xx      2019-08-xx </span></span>
<span><span class="co">#&gt;  2   xxxxxxx Other      Woman  2018-06-xx      2018-06-xx </span></span>
<span><span class="co">#&gt;  3   xxxxxxx Other      Woman  2019-05-xx      2019-05-xx </span></span>
<span><span class="co">#&gt;  4   xxxxxxx Other      Woman  2019-02-xx      2019-02-xx </span></span>
<span><span class="co">#&gt;  5   xxxxxxx Other      Woman  2018-06-xx      2018-06-xx </span></span>
<span><span class="co">#&gt;  6   xxxxxxx Other      Woman  2019-03-xx      2019-03-xx </span></span>
<span><span class="co">#&gt;  7   xxxxxxx Other      Woman  2019-04-xx      2019-04-xx </span></span>
<span><span class="co">#&gt;  8   xxxxxxx Other      Woman  2019-04-xx      2019-04-xx </span></span>
<span><span class="co">#&gt;  9   xxxxxxx Other      Woman  2019-05-xx      2019-05-xx </span></span>
<span><span class="co">#&gt; 10   xxxxxxx Other      Woman  2020-09-xx      2020-09-xx </span></span>
<span><span class="co">#&gt; # ℹ more rows</span></span></code></pre>
<p>Note that the <code><a href="../reference/aou_survey.html">aou_survey()</a></code> function automatically
creates an additional column for every survey variable extracted, which
contains the date the participant answered the question. These are
automatically named by adding “_date” as a suffix to the column
names.</p>
</div>
<div class="section level2">
<h2 id="ehr-data">EHR data<a class="anchor" aria-label="anchor" href="#ehr-data"></a>
</h2>
<p>Now that we have our cohort, we want to create a dataset with data
from these participants’ medical records. We first want to find the
concept ids of the data we want to extract. There are a number of tools
we could use to do so:</p>
<ol style="list-style-type: decimal">
<li>
<p><a href="https://athena.ohdsi.org/" class="external-link">Athena</a>: a web-based tool
for searching the entire OMOP vocabulary. The concept id for Type 2
diabetes mellitus can be found under ID. There are many results for this
search, but we want only standard concepts when searching for EHR
data.</p>
<p><img src="images/diabetes-athena.png" width="600"></p>
</li>
<li>
<p><a href="https://databrowser.researchallofus.org/" class="external-link">Data
Browser</a>: a tool for exploring data in the All of Us database.
Finding the concept id for Type 2 diabetes mellitus requires searching
for that concept and then clicking “Sources”:</p>
<p><img src="images/diabetes-browser.png" width="600"></p>
</li>
<li>
<p><a href="https://workbench.researchallofus.org/" class="external-link">Researcher
Workbench</a>: Creating a concept set can allow you to find a number of
concept ids quickly. Add concepts to your concept set, and then review
the concept set to see them all.</p>
<p><img src="images/diabetes-workbench.png" width="600"></p>
</li>
</ol>
<p>Here are some concepts we may want to include. Keep in mind that this
is an example, and a real analysis would have a more thorough search for
relevant concepts.</p>
<table class="table">
<colgroup>
<col width="16%">
<col width="66%">
<col width="17%">
</colgroup>
<thead><tr class="header">
<th>Concept ID</th>
<th>Concept Name</th>
<th>Domain</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>201826</td>
<td>Type 2 diabetes mellitus</td>
<td>Condition</td>
</tr>
<tr class="even">
<td>4193704</td>
<td>Type 2 diabetes mellitus without complication</td>
<td>Condition</td>
</tr>
<tr class="odd">
<td>40164929</td>
<td>metformin hydrochloride 500 MG Oral Tablet</td>
<td>Drug</td>
</tr>
<tr class="even">
<td>40164897</td>
<td>metformin hydrochloride 1000 MG Oral Tablet</td>
<td>Drug</td>
</tr>
<tr class="odd">
<td>3004410</td>
<td>Hemoglobin A1c/Hemoglobin.total in Blood</td>
<td>Measurement</td>
</tr>
<tr class="even">
<td>3005673</td>
<td>Hemoglobin A1c/Hemoglobin.total in Blood by HPLC</td>
<td>Measurement</td>
</tr>
</tbody>
</table>
<p>First, we’ll extract data on diabetes diagnoses. We can use the
<code>aou_concept_set</code> function to extract data from the All of Us
database. This function takes a cohort, a vector of concepts, and a
domain or set of domains. You can actually extract data from multiple
domains at once – the default is to search all domains. However, it is
helpful to specify the domain(s) when you can, for speed and clarity.
The <code>output =</code> argument specifies the type of data to
extract. Here, we’ll extract an indicator variable for whether the
participant has a diabetes diagnosis at any point in their medical
record. We’ll call that variable “t2dm”.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t2dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aou_concept_set.html">aou_concept_set</a></span><span class="op">(</span><span class="va">cohort</span>,</span>
<span>  concepts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">201826</span>, <span class="fl">4193704</span><span class="op">)</span>,</span>
<span>  domains <span class="op">=</span> <span class="st">"condition"</span>, output <span class="op">=</span> <span class="st">"indicator"</span>,</span>
<span>  concept_set_name <span class="op">=</span> <span class="st">"t2dm"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can also extract data within a certain time window. For example,
if we only want to extract metformin use after joining All of Us, we can
specify a start date as the date the participant answered the gender
question (on the Basics survey). We’ll count how many times the
participant was prescribed metformin after that time point.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metformin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aou_concept_set.html">aou_concept_set</a></span><span class="op">(</span><span class="va">cohort</span>,</span>
<span>  concepts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40164929</span>, <span class="fl">40164897</span><span class="op">)</span>,</span>
<span>  domains <span class="op">=</span> <span class="st">"drug"</span>, output <span class="op">=</span> <span class="st">"count"</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"gender_date"</span>, concept_set_name <span class="op">=</span> <span class="st">"metformin"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For a concept set in the measurement domain, we likely want to set
<code>output = "all"</code> because we are interested in the values of
the measurements, not whether they had any or how many they had.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a1c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aou_concept_set.html">aou_concept_set</a></span><span class="op">(</span><span class="va">cohort</span>,</span>
<span>  concepts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3004410</span>, <span class="fl">3005673</span><span class="op">)</span>,</span>
<span>  domains <span class="op">=</span> <span class="st">"measurement"</span>, output <span class="op">=</span> <span class="st">"all"</span>, start_date <span class="op">=</span> <span class="st">"gender_date"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The output to this is a dataset with one row per measurement. We can
see that the second participant in the output has had 4 A1C measurements
since joining All of Us, while the fifth had 1 and the rest had
none.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a1c</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # Source:   SQL [?? x 9]</span></span>
<span><span class="co">#&gt; # Database: BigQueryConnection</span></span>
<span><span class="co">#&gt;    person_id concept_date concept_id concept_name concept_domain value_as_number</span></span>
<span><span class="co">#&gt;      &lt;int64&gt; &lt;date&gt;          &lt;int64&gt; &lt;chr&gt;        &lt;chr&gt;                    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1   xxxxxx1 NA                   NA NA           NA                        NA  </span></span>
<span><span class="co">#&gt;  2   xxxxxx2 2022-03-xx      3004410 Hemoglobin … Measurement                5.6</span></span>
<span><span class="co">#&gt;  3   xxxxxx2 2021-07-xx      3004410 Hemoglobin … Measurement                5.6</span></span>
<span><span class="co">#&gt;  4   xxxxxx2 2021-05-xx      3004410 Hemoglobin … Measurement                5.5</span></span>
<span><span class="co">#&gt;  5   xxxxxx2 2020-10-xx      3004410 Hemoglobin … Measurement                6  </span></span>
<span><span class="co">#&gt;  6   xxxxxx3 NA                   NA NA           NA                        NA  </span></span>
<span><span class="co">#&gt;  7   xxxxxx4 NA                   NA NA           NA                        NA  </span></span>
<span><span class="co">#&gt;  8   xxxxxx5 2019-04-xx      3005673 Hemoglobin … Measurement                5.9</span></span>
<span><span class="co">#&gt;  9   xxxxxx6 NA                   NA NA           NA                        NA  </span></span>
<span><span class="co">#&gt; 10   xxxxxx7 NA                   NA NA           NA                        NA  </span></span>
<span><span class="co">#&gt; # ℹ more rows</span></span>
<span><span class="co">#&gt; # ℹ 3 more variables: value_as_concept_id &lt;int64&gt;, value_source_value &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   gender_date &lt;date&gt;</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="health-history-survey-data">Health history survey data<a class="anchor" aria-label="anchor" href="#health-history-survey-data"></a>
</h2>
<p>Suppose we want to compare the EHR data to self-reported survey data
on diabetes diagnoses. Returning again to the <code><a href="../reference/aou_survey.html">aou_survey()</a></code>
function, we need to first find the concept id for the question asking
about diabetes diagnoses. Wuestions from the health history surveys are
more complex than others like gender and birthplace: there are branching
questions and complex skip patterns for each question, which were also
asked about family members, and groups of diagnoses were asked about
together. The searchable health history codebook is a useful tool for
finding the concept id for these questions. We can search for “diabetes”
and find the concept id for the question asking about type 2 diabetes
diagnoses for the respondent: 43529932. We can also use the <a href="https://databrowser.researchallofus.org/" class="external-link">Data Browser</a> to find
the same concept id: <img src="images/diabetes-self.png" width="600"></p>
<p>Data from the health history surveys is returned as “Yes”, “No”, or
“Skip”. An observation will have a value of “No” if the participant
answered that someone in their family had the condition, but did not
self-identify as having the condition, or if they responded that no one
in their family had the condition. If they skipped either part of the
question, the value will be “Skip”.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t2dm_self</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aou_survey.html">aou_survey</a></span><span class="op">(</span><span class="va">cohort</span>, questions <span class="op">=</span> <span class="fl">43529932</span>, question_output <span class="op">=</span> <span class="st">"t2dm_survey"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we want to combine these datasets into one. We can do this
using the <code>aou_join</code> function. This function takes a list of
datasets and joins them together using the participant id. The
<code>aou_join</code> function also allows you to specify the type of
join (inner, left, right, or full). Here we’ll perform repeated left
joins into the cohort using the <code><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce()</a></code> function from the
<code>purrr</code> package.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">cohort</span>, <span class="va">t2dm</span>, <span class="va">metformin</span>, <span class="va">a1c</span>, <span class="va">t2dm_self</span><span class="op">)</span>,</span>
<span>  <span class="va">aou_join</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"left"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Our combined dataset has columns for the diabetes diagnosis indicator
from the EHR data, the number of metformin prescriptions, the
self-reported diabetes diagnosis from the health history survey and the
date that survey was completed, as well as complete data on the A1C
measurements. Participants with multiple measurements therefore have
multiple rows in the dataset. We may want to do some additional analyses
before bringing the table off the database and into R. For example, we
may want to summarize the A1C measurements as the highest value for each
participant. We can continue to manipulate the data using
<code>dplyr</code> functions (see
<code>vignette("sql", package = "allofus")</code>).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_data</span> <span class="op">&lt;-</span> <span class="va">combined_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">person_id</span>, <span class="va">birthplace</span>, <span class="va">t2dm</span>, <span class="va">metformin</span>, <span class="va">t2dm_survey</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>max_a1c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">value_as_number</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span></code></pre></div>
<p>This final query may take a few seconds to run – it is the
accumulation of all the queries we’ve run so far (use
<code><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query()</a></code> to see the SQL query that will be run). For
that reason, it is often helpful to print the result of each individual
query to make sure it is what you expect before moving on to the next
step.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_data</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # Source:   SQL [?? x 5]</span></span>
<span><span class="co">#&gt; # Database: BigQueryConnection</span></span>
<span><span class="co">#&gt;    person_id  t2dm metformin t2dm_survey max_a1c</span></span>
<span><span class="co">#&gt;      &lt;int64&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1   xxxxxxx     0         0 NA             NA  </span></span>
<span><span class="co">#&gt;  2   xxxxxxx     0         0 DontKnow       NA  </span></span>
<span><span class="co">#&gt;  3   xxxxxxx     0         0 NA             NA  </span></span>
<span><span class="co">#&gt;  4   xxxxxxx     0         0 No             NA  </span></span>
<span><span class="co">#&gt;  5   xxxxxxx     0         0 NA             NA  </span></span>
<span><span class="co">#&gt;  6   xxxxxxx     0         0 NA             NA  </span></span>
<span><span class="co">#&gt;  7   xxxxxxx     0         0 NA             NA  </span></span>
<span><span class="co">#&gt;  8   xxxxxxx     0         0 No             NA  </span></span>
<span><span class="co">#&gt;  9   xxxxxxx     0         0 NA             NA  </span></span>
<span><span class="co">#&gt; 10   xxxxxxx     0         0 No              5.4</span></span>
<span><span class="co">#&gt; # ℹ more rows</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Louisa Smith, Rob Cavanaugh.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
