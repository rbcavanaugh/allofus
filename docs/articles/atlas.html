<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="allofus">
<title>Using ATLAS to create a cohort • allofus</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Using ATLAS to create a cohort">
<meta property="og:description" content="allofus">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-black"><div class="container">
    <div style="height:40px;display:inline;margin:0 10px;"><a href="https://ohdsi.northeastern.edu/" class="external-link"><img src="https://roux-ohdsi.github.io/allofus/articles/logo.png" style="width:auto;height:100%;"></a></div>
    <a class="navbar-brand me-2" href="../index.html">allofus</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/allofus.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/workspace.html">Managing files on the workbench</a>
    <a class="dropdown-item" href="../articles/data.html">Extracting All of Us survey and EHR data</a>
    <a class="dropdown-item" href="../articles/atlas.html">Using ATLAS to create a cohort</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Codebooks</h6>
    <a class="dropdown-item" href="../articles/web_only/searchable_codebook.html">All of Us Surveys</a>
    <a class="dropdown-item" href="../articles/web_only/health_codebook.html">Health History Surveys</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/roux-ohdsi/allofus/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using ATLAS to create a cohort</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/roux-ohdsi/allofus/blob/HEAD/vignettes/atlas.Rmd" class="external-link"><code>vignettes/atlas.Rmd</code></a></small>
      <div class="d-none name"><code>atlas.Rmd</code></div>
    </div>

    
    
<p>It is often useful to build more complex cohort definitions using
ATLAS, a web-based application that allows users to define cohorts and
run analyses on the OHDSI network. While most of the features of ATLAS
are not compatible with the AllofUS researcher workbench, the All of Us
R package includes a function to download a cohort definition from ATLAS
and generate the cohort in the All of Us database.</p>
<p>To use this feature of the <code>allofus</code>package, you’ll also
need to install the <a href="https://github.com/OHDSI/ROhdsiWebApi" class="external-link"><code>ROhdsiWebApi</code></a>
package from GitHub. This package is used to query the ATLAS API and
download the cohort definition and SQL query. The package is not
available on CRAN (and is therefore not included with the
<code>allofus package</code>), but it can be installed using the
<code>pak</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"pak"</span><span class="op">)</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu">pak</span><span class="op">(</span><span class="st">"ohdsi/ROhdsiWebApi"</span><span class="op">)</span></span></code></pre></div>
<p>After installing the <code>ROhdsiWebApi</code> package, load the
<code>allofus</code> package and the <code>ROhdsiWebApi</code>
package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/allofus/" class="external-link">allofus</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/ROhdsiWebApi/" class="external-link">ROhdsiWebApi</a></span><span class="op">)</span></span></code></pre></div>
<p>If you haven’t already, this is the time to build your cohort
definition in ATLAS. You can use the publicly available <a href="https://atlas-demo.ohdsi.org" class="external-link">demo version of ATLAS</a> which is
pre-populated with many sample cohort definitions (though keep in mind
that they are not validated). You can also use an ATLAS instance in your
organization’s OMOP CDM. (A free, instructional course for using ATLAS
is available through <a href="https://academy.ehden.eu/" class="external-link">EHDEN
Academy</a>.)</p>
<p>In this case, we’ll use the cohort definition 1788061, which is a
simple stroke cohort definition.</p>
<p>Using <code>ROhdsiWebApi</code>, we can download the cohort
definition and SQL query from ATLAS:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd</span> <span class="op">&lt;-</span> <span class="fu">ROhdsiWebApi</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ROhdsiWebApi/reference/getCohortDefinition.html" class="external-link">getCohortDefinition</a></span><span class="op">(</span><span class="fl">1788061</span>, <span class="st">"https://atlas-demo.ohdsi.org/WebAPI"</span><span class="op">)</span></span>
<span><span class="va">cd_sql</span> <span class="op">&lt;-</span> <span class="fu">ROhdsiWebApi</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ROhdsiWebApi/reference/getCohortSql.html" class="external-link">getCohortSql</a></span><span class="op">(</span><span class="va">cd</span>, <span class="st">"https://atlas-demo.ohdsi.org/WebAPI"</span><span class="op">)</span></span></code></pre></div>
<p>Then, we can use the <code><a href="../reference/aou_atlas_cohort.html">aou_atlas_cohort()</a></code> function to
generate the cohort in the All of Us database.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aou_atlas_cohort.html">aou_atlas_cohort</a></span><span class="op">(</span></span>
<span>  cohort_definition <span class="op">=</span> <span class="va">cd</span>,</span>
<span>  cohort_sql <span class="op">=</span> <span class="va">cd_sql</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Because the All of Us program does not use the <a href="https://ohdsi.github.io/CommonDataModel/ehrObsPeriods.html" class="external-link">typical
heuristics</a> for the <code>observation_period</code> table,
observation periods are first generated for each subject using the
<code><a href="../reference/aou_observation_period.html">aou_observation_period()</a></code> function. After generating a new
<code>observation_period</code> table, the SQL from
<code><a href="https://ohdsi.github.io/ROhdsiWebApi/reference/getCohortSql.html" class="external-link">ROhdsiWebApi::getCohortSql()</a></code> will extract a cohort from the
All of Us database - resulting in a <em>local</em> dataframe with the
cohort start and end dates for each subject who fell within the cohort
definition. (The function is based on code from <a href="https://github.com/cmayer2/r4aou" class="external-link uri">https://github.com/cmayer2/r4aou</a> with some tweaks to
generate the appropriate observation periods and incorporate other
package functions.)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cohort</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # A tibble: 6 × 4</span></span>
<span><span class="co">#&gt;   cohort_definition_id person_id cohort_start_date cohort_end_date</span></span>
<span><span class="co">#&gt;                  &lt;int&gt; &lt;int&gt;     &lt;date&gt;            &lt;date&gt;         </span></span>
<span><span class="co">#&gt; 1              1788061 xxxxxxx   1995-03-27        1995-03-27     </span></span>
<span><span class="co">#&gt; 2              1788061 xxxxxxx   2012-01-07        2012-01-21     </span></span>
<span><span class="co">#&gt; 3              1788061 xxxxxxx   2010-06-17        2016-04-05     </span></span>
<span><span class="co">#&gt; 4              1788061 xxxxxxx   2015-08-12        2017-08-30     </span></span>
<span><span class="co">#&gt; 5              1788061 xxxxxxx   2017-01-24        2019-01-24     </span></span>
<span><span class="co">#&gt; 6              1788061 xxxxxxx   2008-07-09        2019-01-24</span></span></code></pre>
<p>To use this cohort table further, you can join it to other tables
from the All of Us database (after they have been “collected”). Or, to
use this table to limit the person table (or other OMOP CDM tables) to
only your cohort, filter for the values in the
<code>cohort$person_id</code> column:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"person"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">person_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="op">!</span><span class="op">!</span><span class="va">cohort</span><span class="op">$</span><span class="va">person_id</span><span class="op">)</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Louisa Smith, Rob Cavanaugh.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
