<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="allofus">
<title>SQL in R • allofus</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="SQL in R">
<meta property="og:description" content="allofus">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-black"><div class="container">
    <div style="height:40px;display:inline;margin:0 10px;"><a href="https://ohdsi.northeastern.edu/" class="external-link"><img src="https://roux-ohdsi.github.io/allofus/articles/logo.png" style="width:auto;height:100%;"></a></div>
    <a class="navbar-brand me-2" href="../index.html">allofus</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/sql.html">SQL in R</a>
    <a class="dropdown-item" href="../articles/workspace.html">Managing files on the workbench</a>
    <a class="dropdown-item" href="../articles/data.html">Extracting All of Us survey and EHR data</a>
    <a class="dropdown-item" href="../articles/atlas.html">Using ATLAS to create a cohort</a>
    <a class="dropdown-item" href="../articles/web_only/searchable_codebook.html">Searchable Codebook for AllofUs Surveys</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/roux-ohdsi/allofus/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>SQL in R</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/roux-ohdsi/allofus/blob/HEAD/vignettes/sql.Rmd" class="external-link"><code>vignettes/sql.Rmd</code></a></small>
      <div class="d-none name"><code>sql.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-basics">The Basics<a class="anchor" aria-label="anchor" href="#the-basics"></a>
</h2>
<p>Before diving into the specifics, let’s clarify some vocabulary:</p>
<ul>
<li>
<strong>SQL database</strong> : A structured collection of data
where information is stored in tables. Each table is like a spreadsheet
with rows and columns. Data can be added, removed, or modified using SQL
queries.</li>
<li>
<strong>SQL query</strong> : A request for data from a database
written in a language called SQL (Structured Query Language).</li>
<li>
<strong>Google BigQuery</strong> : A cloud-based SQL database that
is used to store the All of Us data.</li>
<li>
<strong>bigrquery</strong> : An R package that allows you to
interact with Google BigQuery from R.</li>
<li>
<strong>dplyr</strong>: A part of the <code>tidyverse</code> in R,
<code>dplyr</code> is a package for data manipulation. It provides a set
of functions that can be used to filter, select, arrange, mutate,
summarize, and join data.</li>
<li>
<strong>dbplyr</strong> : Also a part of the <code>tidyverse</code>
in R, <code>dbplyr</code> is a database backend for <code>dplyr</code>.
It allows you to write R code that is then translated into SQL
queries.</li>
</ul>
</div>
<div class="section level2">
<h2 id="accessing-data">Accessing Data<a class="anchor" aria-label="anchor" href="#accessing-data"></a>
</h2>
<div class="section level3">
<h3 id="connecting-to-the-database">Connecting to the database<a class="anchor" aria-label="anchor" href="#connecting-to-the-database"></a>
</h3>
<p>A connection to a database is an object that allows you to interact
with it from R. The <code>allofus</code> package relies on the
<code>bigrquery</code> R package to create a connection to the Google
BigQuery database when you run <code><a href="../reference/aou_connect.html">aou_connect()</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/allofus/" class="external-link">allofus</a></span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aou_connect.html">aou_connect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The object <code>con</code> is used to refer to the connection to the
All of Us database. When you run the <code><a href="../reference/aou_connect.html">aou_connect()</a></code>
function, it also gets stored as the default connection for a session,
so you don’t need to include it in other functions from the
<code>allofus</code> package. For instance, you can run
<code><a href="../reference/aou_tables.html">aou_tables()</a></code> to see a list of tables in the database:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/aou_tables.html">aou_tables</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 68 × 2</span></span></span>
<span><span class="co">#&gt;    table_name               columns                                             </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                               </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> concept_ancestor         ancestor_concept_id, descendant_concept_id, min_lev…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> cb_criteria_ancestor     ancestor_id, descendant_id                          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> attribute_definition     attribute_definition_id, attribute_name, attribute_…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> cdm_source               cdm_source_name, cdm_source_abbreviation, cdm_holde…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> concept_class            concept_class_id, concept_class_name, concept_class…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> concept                  concept_id, concept_name, domain_id, vocabulary_id,…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> concept_synonym          concept_id, concept_synonym_name, language_concept_…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> cb_criteria_relationship concept_id_1, concept_id_2                          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> concept_relationship     concept_id_1, concept_id_2, relationship_id, valid_…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> condition_occurrence     condition_occurrence_id, person_id, condition_conce…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 58 more rows</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="accessing-a-table">Accessing a table<a class="anchor" aria-label="anchor" href="#accessing-a-table"></a>
</h3>
<p>To access a table in the database, use
<code>tbl(con, "tablename")</code>. The resulting object is reference to
a table in a database that allows you to interact with it from R. In
order to connect to a table in the database, you must first create the
database connection (<code>con</code>). For example, to create a
reference to the person table:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">person_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"person"</span><span class="op">)</span></span></code></pre></div>
<p>Although the <code>person_tbl</code> object behaves similarly to a
data frame, it is not actually a data frame. Instead, it is actually a
SQL query that only gets run when you need to access the data. This is a
feature of the <code>dbplyr</code> package that allows you to manipulate
data without actually retrieving it. The SQL query behind the
<code>person_tbl</code> object is:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="kw">FROM</span> `person`</span></code></pre></div>
<p>When you print <code>person_tbl</code>, you’ll get something like
this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">person_tbl</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # Source:   table&lt;person&gt; [?? x 23]</span></span>
<span><span class="co">#&gt; # Database: BigQueryConnection</span></span>
<span><span class="co">#&gt;    person_id gender_concept_id year_of_birth month_of_birth day_of_birth</span></span>
<span><span class="co">#&gt;      &lt;int64&gt;           &lt;int64&gt;       &lt;int64&gt;        &lt;int64&gt;      &lt;int64&gt;</span></span>
<span><span class="co">#&gt;  1   xxxxxxx            903096          1955             NA           NA</span></span>
<span><span class="co">#&gt;  2   xxxxxxx            903096          1978             NA           NA</span></span>
<span><span class="co">#&gt;  3   xxxxxxx            903096          2000             NA           NA</span></span>
<span><span class="co">#&gt;  4   xxxxxxx            903096          1988             NA           NA</span></span>
<span><span class="co">#&gt;  5   xxxxxxx            903096          1993             NA           NA</span></span>
<span><span class="co">#&gt;  6   xxxxxxx            903096          1959             NA           NA</span></span>
<span><span class="co">#&gt;  7   xxxxxxx            903096          1976             NA           NA</span></span>
<span><span class="co">#&gt;  8   xxxxxxx            903096          1961             NA           NA</span></span>
<span><span class="co">#&gt;  9   xxxxxxx            903096          1952             NA           NA</span></span>
<span><span class="co">#&gt; 10   xxxxxxx            903096          1980             NA           NA</span></span>
<span><span class="co">#&gt; # ℹ more rows</span></span>
<span><span class="co">#&gt; # ℹ 18 more variables: birth_datetime &lt;dttm&gt;, race_concept_id &lt;int64&gt;,</span></span>
<span><span class="co">#&gt; #   ethnicity_concept_id &lt;int64&gt;, location_id &lt;int64&gt;, provider_id &lt;int64&gt;,</span></span>
<span><span class="co">#&gt; #   care_site_id &lt;int64&gt;, person_source_value &lt;chr&gt;, gender_source_value &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   gender_source_concept_id &lt;int64&gt;, race_source_value &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   race_source_concept_id &lt;int64&gt;, ethnicity_source_value &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   ethnicity_source_concept_id &lt;int64&gt;, …</span></span></code></pre>
<p>You’ll only see the first 10 rows of the person table (person ids
were omitted from the output). This allows you to see what the data
looks like without loading the entire table into R, which can be slow or
even crash your session.</p>
<p>Instead, you want to perform as much data manipulation as possible on
the database. This is more efficient because the operations are
translated into SQL and executed on the server, which is faster and
requires less memory than processing in R.</p>
</div>
</div>
<div class="section level2">
<h2 id="data-manipulation-on-the-database">Data manipulation on the database<a class="anchor" aria-label="anchor" href="#data-manipulation-on-the-database"></a>
</h2>
<p>Before bringing data into R, you can manipulate it on the database
using the <code>dplyr</code> functions. This allows you to perform
operations on the database without bringing the data into R’s
memory.</p>
<p>For example, you can subset the person table to women born after
1980:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">young_women</span> <span class="op">&lt;-</span> <span class="va">person_tbl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">gender_concept_id</span> <span class="op">==</span> <span class="fl">45878463</span>, <span class="va">year_of_birth</span> <span class="op">&gt;</span> <span class="fl">1980</span><span class="op">)</span></span></code></pre></div>
<p>Before we print out <code>young_women</code>, the SQL query has not
actually been run. In fact, <code>person_tbl</code> is not run either.
When we do print it, it will run the following SQL:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">SELECT</span> `person`.<span class="op">*</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="kw">FROM</span> `person`</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="kw">WHERE</span> (`gender_concept_id` <span class="op">=</span> <span class="fl">45878463.0</span>) <span class="kw">AND</span> (`year_of_birth` <span class="op">&gt;</span> <span class="fl">1980.0</span>)</span></code></pre></div>
<p>and print the first 10 rows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">young_women</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # Source:   SQL [?? x 23]</span></span>
<span><span class="co">#&gt; # Database: BigQueryConnection</span></span>
<span><span class="co">#&gt;    person_id gender_concept_id year_of_birth month_of_birth day_of_birth</span></span>
<span><span class="co">#&gt;      &lt;int64&gt;           &lt;int64&gt;       &lt;int64&gt;        &lt;int64&gt;      &lt;int64&gt;</span></span>
<span><span class="co">#&gt;  1   xxxxxxx          45878463          1992             NA           NA</span></span>
<span><span class="co">#&gt;  2   xxxxxxx          45878463          1989             NA           NA</span></span>
<span><span class="co">#&gt;  3   xxxxxxx          45878463          1981             NA           NA</span></span>
<span><span class="co">#&gt;  4   xxxxxxx          45878463          1990             NA           NA</span></span>
<span><span class="co">#&gt;  5   xxxxxxx          45878463          1990             NA           NA</span></span>
<span><span class="co">#&gt;  6   xxxxxxx          45878463          1985             NA           NA</span></span>
<span><span class="co">#&gt;  7   xxxxxxx          45878463          1987             NA           NA</span></span>
<span><span class="co">#&gt;  8   xxxxxxx          45878463          1986             NA           NA</span></span>
<span><span class="co">#&gt;  9   xxxxxxx          45878463          1983             NA           NA</span></span>
<span><span class="co">#&gt; 10   xxxxxxx          45878463          1998             NA           NA</span></span>
<span><span class="co"># ℹ more rows</span></span>
<span><span class="co"># ℹ 18 more variables: birth_datetime &lt;dttm&gt;, race_concept_id &lt;int64&gt;,</span></span>
<span><span class="co">#   ethnicity_concept_id &lt;int64&gt;, location_id &lt;int64&gt;, provider_id &lt;int64&gt;,</span></span>
<span><span class="co">#   care_site_id &lt;int64&gt;, person_source_value &lt;chr&gt;, gender_source_value &lt;chr&gt;,</span></span>
<span><span class="co">#   gender_source_concept_id &lt;int64&gt;, race_source_value &lt;chr&gt;,</span></span>
<span><span class="co">#   race_source_concept_id &lt;int64&gt;, ethnicity_source_value &lt;chr&gt;,</span></span>
<span><span class="co">#   ethnicity_source_concept_id &lt;int64&gt;, …</span></span></code></pre>
<p>Note that we don’t know how many observations match these conditions
yet (the dimensions are <code>[?? x 23]</code>), because it hasn’t been
fully executed – only the first 10 rows. To get the total number of
observations, we can use <code><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="va">young_women</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # Source:   SQL [1 x 1]</span></span>
<span><span class="co">#&gt; # Database: BigQueryConnection</span></span>
<span><span class="co">#&gt;         n</span></span>
<span><span class="co">#&gt;   &lt;int64&gt;</span></span>
<span><span class="co">#&gt; 1   76135</span></span></code></pre>
<p>This is actually a SQL query that only results in 1 row, so we do get
to see the entire thing. It’s much faster to run than to bring the
entire table into R and then count the number of rows, because the code
is executed on the database:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> `n`</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  <span class="kw">SELECT</span> `person`.<span class="op">*</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  <span class="kw">FROM</span> `person`</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  <span class="kw">WHERE</span> (`gender_concept_id` <span class="op">=</span> <span class="fl">45878463.0</span>) <span class="kw">AND</span> (`year_of_birth` <span class="op">&gt;</span> <span class="fl">1980.0</span>)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>)</span></code></pre></div>
<div class="section level3">
<h3 id="the-collect-function">The <code>collect()</code> Function<a class="anchor" aria-label="anchor" href="#the-collect-function"></a>
</h3>
<p>We can bring the result of a query into the local R session using
<code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">young_women</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This brings the table into your local R workspace as a tibble, or
dataframe. This is useful for performing operations that cannot be
performed directly on the database, such as certain statistical analyses
or plotting. For example, if you’re planning to run a regression
analysis on the filtered data, you would first use
<code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> to bring the data into R.</p>
<p>We can bring in the result of <code><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally()</a></code> as well:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="va">young_women</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; A tibble: 1 × 1</span></span>
<span><span class="co">#&gt;       n</span></span>
<span><span class="co">#&gt; &lt;int64&gt;</span></span>
<span><span class="co">#&gt;   76135</span></span></code></pre>
<p>Or even the entire person table, although that’s not recommended
because it’s so large!</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">person_data</span> <span class="op">&lt;-</span> <span class="va">person_tbl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">person_data</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # A tibble: 413457 × 23</span></span>
<span><span class="co">#&gt; person_id    gender_concept_id   year_of_birth   month_of_birth  day_of_birth    </span></span>
<span><span class="co">#&gt;   &lt;int64&gt;              &lt;int64&gt;         &lt;int64&gt;          &lt;int64&gt;       &lt;int64&gt;</span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            1955               NA            NA    </span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            1978               NA            NA</span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            2000               NA            NA</span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            1988               NA            NA</span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            1993               NA            NA</span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            1959               NA            NA</span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            1976               NA            NA</span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            1961               NA            NA</span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            1952               NA            NA</span></span>
<span><span class="co">#&gt;   xxxxxxx               903096            1980               NA            NA    </span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="data-manipulation-with-multiple-tables">Data manipulation with multiple tables<a class="anchor" aria-label="anchor" href="#data-manipulation-with-multiple-tables"></a>
</h2>
<p>The All of Us data is spread across multiple tables, for the most
part corresponding to the OMOP Common Data Model. This allows for
efficient storage and retrieval of data, but it can be a bit tricky to
work with at first. Fortunately, <code>dbplyr</code> makes it easy to
join tables together.</p>
<p>For example, how did we know that
<code>gender_concept_id == 45878463</code> referred to women? We can
look up the names of concept ids in the <code>concept</code> table:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">concept_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"concept"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">concept_id</span>, <span class="va">concept_name</span><span class="op">)</span></span>
<span><span class="va">concept_tbl</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # Source:   SQL [?? x 2]</span></span>
<span><span class="co">#&gt; # Database: BigQueryConnection</span></span>
<span><span class="co">#&gt;    concept_id concept_name                                      </span></span>
<span><span class="co">#&gt;       &lt;int64&gt; &lt;chr&gt;                                             </span></span>
<span><span class="co">#&gt;  1   38003166 Durable Medical Equipment - General Classification</span></span>
<span><span class="co">#&gt;  2   35805830 DexaBEAM                                          </span></span>
<span><span class="co">#&gt;  3   38003221 Blood - Plasma                                    </span></span>
<span><span class="co">#&gt;  4    1147839 survey_conduct.survey_start_date                  </span></span>
<span><span class="co">#&gt;  5       8623 log reduction                                     </span></span>
<span><span class="co">#&gt;  6   38004063 Rehabilitation Practitioner                       </span></span>
<span><span class="co">#&gt;  7   38003186 Radiology - Diagnostic - General Classification   </span></span>
<span><span class="co">#&gt;  8   35805115 VNCOP-B                                           </span></span>
<span><span class="co">#&gt;  9   35805457 VAdCA                                             </span></span>
<span><span class="co">#&gt; 10       8581 heartbeat                                         </span></span>
<span><span class="co">#&gt; # ℹ more rows</span></span></code></pre>
<p>We just want to extract the names of the gender concept ids. To do
this, we can join the <code>person</code> table with the
<code>concept</code> table. So that we can see the full range of gender
ids, first we will count them:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genders_in_aou</span> <span class="op">&lt;-</span> <span class="va">person_tbl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">gender_concept_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">concept_tbl</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">gender_concept_id</span> <span class="op">==</span> <span class="va">concept_id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">genders_in_aou</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; # Source:   SQL [9 x 3]</span></span>
<span><span class="co">#&gt; # Database: BigQueryConnection</span></span>
<span><span class="co">#&gt;   gender_concept_id       n concept_name                                        </span></span>
<span><span class="co">#&gt;             &lt;int64&gt; &lt;int64&gt; &lt;chr&gt;                                               </span></span>
<span><span class="co">#&gt; 1           1177221     602 I prefer not to answer                              </span></span>
<span><span class="co">#&gt; 2                 0      97 No matching concept                                 </span></span>
<span><span class="co">#&gt; 3          45878463  247453 Female                                              </span></span>
<span><span class="co">#&gt; 4           1585843     407 Gender Identity: Additional Options                 </span></span>
<span><span class="co">#&gt; 5            903096    7356 PMI: Skip                                           </span></span>
<span><span class="co">#&gt; 6          45880669  154241 Male                                                </span></span>
<span><span class="co">#&gt; 7           1585842     562 Gender Identity: Transgender                        </span></span>
<span><span class="co">#&gt; 8           1585841    1213 Gender Identity: Non Binary                         </span></span>
<span><span class="co">#&gt; 9        2000000002    1526 Not man only, not woman only, prefer not to answer,…</span></span></code></pre>
<p>The result of this SQL query is just 9 rows, so we get to see all of
them. Both the counting and the joining were done directly on the
database, so this was very efficient.</p>
<div class="section level3">
<h3 id="aou_join">
<code>aou_join()</code><a class="anchor" aria-label="anchor" href="#aou_join"></a>
</h3>
<p>The <code>allofus</code> package includes a function called
<code><a href="../reference/aou_join.html">aou_join()</a></code> that makes it easy to join tables together. It
includes some additional checks to help avoid mistakes in joining. For
example, if we wanted to join the <code>person</code> table with the
<code>observation</code> table, dropping people with no observations, we
could do it like this:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">person_tbl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/aou_join.html">aou_join</a></span><span class="op">(</span><span class="st">"observation"</span>, type <span class="op">=</span> <span class="st">"inner"</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span></span></code></pre></div>
<pre><code>Warning message:
“There are shared column names not specified in the `by` argument.
→ These column names now end in '_x' and '_y'.
ℹ You can change these suffixes using the `suffix` argument but it cannot
  contain periods (`.`).
→ Consider specifing all shared columns in the `by` argument.
→ Or if these additional shared columns are `NA`, remove them prior to joining.”</code></pre>
<p>The warning message tells us that the <code>person</code> and
<code>observation</code> tables share some column names that we didn’t
specify as part of the join argument. That is because both tables have a
column called <code>provider_id</code>. We can see this by looking at
the column names of the <code>obs</code> table that have the default
added suffix, “_x” and “_y”:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"_x"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">ends_with</a></span><span class="op">(</span><span class="st">"_y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] "provider_id_x" "provider_id_y"</span></span></code></pre>
<p>Because this is often a mistake occurring because we are not working
with the tables directly, <code><a href="../reference/aou_join.html">aou_join()</a></code> warns us about this.
We can avoid this warning by specifying all of the columns that we want
to join on and removing the columns that we don’t want to join on. For
example, we could remove the <code>provider_id</code> column from the
<code>person</code> table before joining:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">person_tbl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">provider_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/aou_join.html">aou_join</a></span><span class="op">(</span><span class="st">"observation"</span>, type <span class="op">=</span> <span class="st">"inner"</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="viewing-the-underlying-sql-with-show_query">Viewing the Underlying SQL with <code>show_query()</code><a class="anchor" aria-label="anchor" href="#viewing-the-underlying-sql-with-show_query"></a>
</h2>
<p>Understanding the SQL code that <code>dbplyr</code> generates can be
insightful, especially if you’re debugging or simply curious about the
translation from R to SQL. To view the SQL query that corresponds to
your <code>dbplyr</code> operations, use the <code><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query()</a></code>
function:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>SELECT
  `edjnngldox`.`person_id` AS `person_id`,
  `gender_concept_id`,
  `year_of_birth`,
  `month_of_birth`,
  `day_of_birth`,
  `birth_datetime`,
  `race_concept_id`,
  `ethnicity_concept_id`,
  `location_id`,
  `care_site_id`,
  `person_source_value`,
  `gender_source_value`,
  `gender_source_concept_id`,
  `race_source_value`,
  `race_source_concept_id`,
  `ethnicity_source_value`,
  `ethnicity_source_concept_id`,
  `state_of_residence_concept_id`,
  `state_of_residence_source_value`,
  `sex_at_birth_concept_id`,
  `sex_at_birth_source_concept_id`,
  `sex_at_birth_source_value`,
  `observation_id`,
  `observation_concept_id`,
  `observation_date`,
  `observation_datetime`,
  `observation_type_concept_id`,
  `value_as_number`,
  `value_as_string`,
  `value_as_concept_id`,
  `qualifier_concept_id`,
  `unit_concept_id`,
  `zwcwezaowf`.`provider_id` AS `provider_id`,
  `visit_occurrence_id`,
  `visit_detail_id`,
  `observation_source_value`,
  `observation_source_concept_id`,
  `unit_source_value`,
  `qualifier_source_value`,
  `value_source_concept_id`,
  `value_source_value`,
  `questionnaire_response_id`
FROM `person` `edjnngldox`
INNER JOIN `observation` `zwcwezaowf`
  ON (`edjnngldox`.`person_id` = `zwcwezaowf`.`person_id`)</code></pre>
<p>This function prints the SQL query that would be sent to the
database. It’s a great way to learn SQL and understand how
<code>dbplyr</code> optimizes data manipulation. (Why the gibberish
table names? Bugs in previous versions of <code>dbplyr</code> resulted
in table names that would break the query, and giving them unique names
is a workaround.)</p>
</div>
<div class="section level2">
<h2 id="running-sql-code-directly">Running SQL code directly<a class="anchor" aria-label="anchor" href="#running-sql-code-directly"></a>
</h2>
<p>Another approach to working with the data is to write SQL code
directly. This is especially useful for complex queries that are
difficult to express in <code>dplyr</code> syntax. The
<code>allofus</code> package includes a function called
<code><a href="../reference/aou_sql.html">aou_sql()</a></code> that makes it easy to run SQL code directly on
the database. For example, we could count the number of people in the
<code>person</code> table like this:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/aou_sql.html">aou_sql</a></span><span class="op">(</span><span class="st">"SELECT COUNT(*) AS n FROM {CDR}.person"</span><span class="op">)</span></span></code></pre></div>
<p>There are a few important things to note about this code. First, the
<code>CDR</code> variable is a special variable referring to what All of
Us calls the “curated data repository”. When writing SQL code directly,
we don’t need the database connection object <code>con</code>, instead
we need to direct the code to the correct tables by preceding the table
names with “{CDR}”. This means we can’t run the code we get from
<code><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query()</a></code> without modification. For example, we could
count the number of young women in the dataset, as we did above with the
<code>dbplyr</code> approach, like this:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/aou_sql.html">aou_sql</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">SELECT count(*) AS `n`</span></span>
<span><span class="st">FROM (</span></span>
<span><span class="st">  SELECT `person`.*</span></span>
<span><span class="st">  FROM {CDR}.`person`</span></span>
<span><span class="st">  WHERE (`gender_concept_id` = 45878463.0) AND (`year_of_birth` &gt; 1980.0)</span></span>
<span><span class="st">)</span></span>
<span><span class="st">"</span><span class="op">)</span></span></code></pre></div>
<p>Second, the <code><a href="../reference/aou_sql.html">aou_sql()</a></code> function returns a dataframe – the
entire result of the SQL query is brought into memory. This means that
we want to run an entire query at once, instead of breaking it into
multiple steps like we did with <code>dbplyr</code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Louisa Smith, Rob Cavanaugh.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
