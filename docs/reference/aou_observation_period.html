<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Generates a temporary observation period table based the first and last event in
the electronic medical record data. Because some EHR sites have contributed data from several decades ago, researchers
might want to consider further constraining this table to reasonable date ranges of interest
(e.g., setting all observation_period_start_date values to no earlier than 01/01/2010)."><title>Generate an observation period table — aou_observation_period • allofus</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Generate an observation period table — aou_observation_period"><meta property="og:description" content="Generates a temporary observation period table based the first and last event in
the electronic medical record data. Because some EHR sites have contributed data from several decades ago, researchers
might want to consider further constraining this table to reasonable date ranges of interest
(e.g., setting all observation_period_start_date values to no earlier than 01/01/2010)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-black"><div class="container">
    <div style="height:40px;display:inline;margin:0 10px;"><a href="https://ohdsi.northeastern.edu/" class="external-link"><img src="https://roux-ohdsi.github.io/allofus/articles/logo.png" style="width:auto;height:100%;"></a></div>
    <a class="navbar-brand me-2" href="../index.html">allofus</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/allofus.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/workspace.html">Managing files on the workbench</a>
    <a class="dropdown-item" href="../articles/data.html">Extracting All of Us survey and EHR data</a>
    <a class="dropdown-item" href="../articles/atlas.html">Using ATLAS to create a cohort</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Codebooks</h6>
    <a class="dropdown-item" href="../articles/web_only/searchable_codebook.html">All of Us Surveys</a>
    <a class="dropdown-item" href="../articles/web_only/health_codebook.html">Health History Surveys</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/roux-ohdsi/allofus/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Generate an observation period table</h1>
      <small class="dont-index">Source: <a href="https://github.com/roux-ohdsi/allofus/blob/HEAD/R/aou_obs_period.R" class="external-link"><code>R/aou_obs_period.R</code></a></small>
      <div class="d-none name"><code>aou_observation_period.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Generates a temporary observation period table based the first and last event in
the electronic medical record data. Because some EHR sites have contributed data from several decades ago, researchers
might want to consider further constraining this table to reasonable date ranges of interest
(e.g., setting all observation_period_start_date values to no earlier than 01/01/2010).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">aou_observation_period</span><span class="op">(</span></span>
<span>  cohort <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  collect <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  con <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"aou.default.con"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>cohort</dt>
<dd><p>Reference to a remote table or local dataframe with a column called "person_id"</p></dd>


<dt>collect</dt>
<dd><p>Whether to bring the resulting table into local memory
(<code>collect = TRUE</code>) as a dataframe or leave as a reference to a database table (for
continued analysis using, e.g., <code>dbplyr</code>). Defaults to <code>FALSE.</code></p></dd>


<dt>...</dt>
<dd><p>Further arguments passed along to <code>collect()</code> if <code>collect = TRUE</code></p></dd>


<dt>con</dt>
<dd><p>Connection to the allofus SQL database. Defaults to getOption("aou.default.con"), which is set automatically if you use <code><a href="aou_connect.html">aou_connect()</a></code></p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A dataframe if <code>collect = TRUE</code>; a reference to a remote database table if not. Columns will be "person_id", "observation_period_start_date", and "observation_period_end_date".</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a></p>
<p>The current observation period table in the All of Us OMOP CDM is not always
appropriate for cohorts generated using OHDSI tools such as ATLAS. Some observation
periods are overly short and some participants have hundreds of observation periods.</p>
<p>This function generates an observation period table from the first occurrence of
a clinical event in the EHR tables to the last clinical event in the EHR tables.
It will only return a single observation period per person_id in the database. If
<code>collect = FALSE</code>, the function returns a query to a temporary table in the database
which can be referenced by typical dplyr functions.</p>
<p>Normal OMOP conventions for EHR suggest that long lapses of time bewteen clinical
events may indicate that the person was not "observed" during this period. However,
due to the diverse nature of clinical EHR data contributed to all of us, it seems
most conservative to assume that the person was observed from their first to last
clinical event. See https://ohdsi.github.io/CommonDataModel/ehrObsPeriods.html
for more details.</p>
<p>Some users have clinical events going back to before the time of widespread
electronic medical record use (e.g., the 1980s and 1990s). This function considers
all EHR data in the database, regardless of the date of the clinical event, but we
recommend that users consider the implications of including data from the 1980s and 1990s.
It may be more prudent to exclude data prior to a more recent cutoff date so that the EHR
data is more likely to be accurate, though this decision depends highly on the research
question (see example below).</p>
<p>Users should note that the aou_observation_period function will only generate observation periods for
participants who have at least one clinical observation. If participant in the AllofUs research
program who did not include electronic health record data are included in the cohort argument, or
elected to contribute data but have no data to contribute, they will not be included in the
generated observation period table.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># on_workbench()</span></span></span>
<span class="r-in"><span><span class="co"># create observation_period table for everyone</span></span></span>
<span class="r-in"><span><span class="va">observation_period_tbl</span> <span class="op">&lt;-</span> <span class="fu">aou_observation_period</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># create an index date as the first date a survey was taken</span></span></span>
<span class="r-in"><span><span class="va">index_date_tbl</span> <span class="op">&lt;-</span> <span class="fu">tbl</span><span class="op">(</span><span class="va">con</span>, <span class="st">"ds_survey"</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">person_id</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">survey_datetime</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">survey_datetime</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">mutate</span><span class="op">(</span>index_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">survey_datetime</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">person_id</span>, <span class="va">index_date</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># create a cohort of participants with EHR data and at least one year</span></span></span>
<span class="r-in"><span><span class="co"># of observation starting on the date they took the first survey</span></span></span>
<span class="r-in"><span><span class="va">cohort</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cb_search_person"</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">has_ehr_data</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">index_date_tbl</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">observation_period_tbl</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">observation_period_end_date</span> <span class="op">&gt;=</span> <span class="fu"><a href="DATE_ADD.html">DATE_ADD</a></span><span class="op">(</span><span class="va">index_date</span>,</span></span>
<span class="r-in"><span>                                                 <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sql.html" class="external-link">sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"INTERVAL "</span>, <span class="fl">1</span>, <span class="st">" year"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>         <span class="va">observation_period_start_date</span> <span class="op">&lt;=</span> <span class="va">index_date</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">select</span><span class="op">(</span><span class="va">person_id</span>, <span class="va">gender</span>, <span class="va">sex_at_birth</span>, <span class="va">race</span>, <span class="va">ethnicity</span>, <span class="va">age_at_consent</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># head(cohort)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># create an observation period table with a minimum start date (e.g., 2010-01-01)</span></span></span>
<span class="r-in"><span><span class="va">observation_period_tbl</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">mutate</span><span class="op">(</span>observation_period_start_date <span class="op">=</span></span></span>
<span class="r-in"><span>           <span class="fu">if_else</span><span class="op">(</span><span class="va">observation_period_start_date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2010-01-01"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                   <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2010-01-01"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                   <span class="va">observation_period_start_date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">observation_period_end_date</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2010-01-01"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Louisa Smith, Rob Cavanaugh.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

