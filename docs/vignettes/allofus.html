<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>allofus - All of Us in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../vignettes/atlas.html" rel="next">
<link href="../images/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/apple-touch-icon-180x180.png" alt="Northeastern University logo" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">allofus</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/roux-ohdsi/allofus"> <i class="bi bi-github" role="img" aria-label="allofus GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../vignettes/allofus.html">Getting Started</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../vignettes/allofus.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../vignettes/atlas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using ATLAS to create a cohort</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../vignettes/data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Extracting All of Us survey and EHR data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../vignettes/workspace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Managing files on the workbench</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Codebooks</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../vignettes/web_only/health_codebook.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Health History Surveys</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../vignettes/web_only/searchable_codebook.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">All of Us Surveys</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Reference</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_atlas_cohort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_atlas_cohort</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_bucket_to_workspace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_bucket_to_workspace</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_codebook.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_codebook</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_collect.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_collect</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_compute.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_compute</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_concept_set.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_concept_set</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_connect.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_connect</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_create_temp_table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_create_temp_table</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_health_history.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_health_history</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_join.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_join</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_ls_bucket.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_ls_bucket</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_ls_workspace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_ls_workspace</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_observation_period.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_observation_period</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_session_info.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_session_info</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_sql.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_sql</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_survey.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_survey</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_table_info.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_table_info</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_tables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../man/aou_workspace_to_bucket.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aou_workspace_to_bucket</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../NEWS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">News</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../LICENSE.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">License</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../CITATION.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Citation</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-basics" id="toc-the-basics" class="nav-link active" data-scroll-target="#the-basics">The Basics</a></li>
  <li><a href="#accessing-data" id="toc-accessing-data" class="nav-link" data-scroll-target="#accessing-data">Accessing Data</a>
  <ul class="collapse">
  <li><a href="#connecting-to-the-database" id="toc-connecting-to-the-database" class="nav-link" data-scroll-target="#connecting-to-the-database">Connecting to the database</a></li>
  <li><a href="#accessing-a-table" id="toc-accessing-a-table" class="nav-link" data-scroll-target="#accessing-a-table">Accessing a table</a></li>
  </ul></li>
  <li><a href="#data-manipulation-on-the-database" id="toc-data-manipulation-on-the-database" class="nav-link" data-scroll-target="#data-manipulation-on-the-database">Data manipulation on the database</a>
  <ul class="collapse">
  <li><a href="#the-collect-function" id="toc-the-collect-function" class="nav-link" data-scroll-target="#the-collect-function">The <code>collect()</code> Function</a></li>
  </ul></li>
  <li><a href="#data-manipulation-with-multiple-tables" id="toc-data-manipulation-with-multiple-tables" class="nav-link" data-scroll-target="#data-manipulation-with-multiple-tables">Data manipulation with multiple tables</a>
  <ul class="collapse">
  <li><a href="#aou_join" id="toc-aou_join" class="nav-link" data-scroll-target="#aou_join"><code>aou_join()</code></a></li>
  </ul></li>
  <li><a href="#joins-from-different-sources" id="toc-joins-from-different-sources" class="nav-link" data-scroll-target="#joins-from-different-sources">Joins from different sources?</a></li>
  <li><a href="#viewing-the-underlying-sql-with-show_query" id="toc-viewing-the-underlying-sql-with-show_query" class="nav-link" data-scroll-target="#viewing-the-underlying-sql-with-show_query">Viewing the Underlying SQL with <code>show_query()</code></a></li>
  <li><a href="#running-sql-code-directly" id="toc-running-sql-code-directly" class="nav-link" data-scroll-target="#running-sql-code-directly">Running SQL code directly</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">All of Us in R</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="the-basics" class="level2">
<h2 class="anchored" data-anchor-id="the-basics">The Basics</h2>
<p>Before diving into the specifics, let’s clarify some vocabulary:</p>
<ul>
<li><strong>SQL database</strong> : A structured collection of data where information is stored in tables. Each table is like a spreadsheet with rows and columns. Data can be added, removed, or modified using SQL queries.</li>
<li><strong>SQL query</strong> : A request for data from a database written in a language called SQL (Structured Query Language).</li>
<li><strong>Google BigQuery</strong> : A cloud-based SQL database that is used to store the All of Us data.</li>
<li><strong>bigrquery</strong> : An R package that allows you to interact with Google BigQuery from R.</li>
<li><strong>dplyr</strong>: A part of the <code>tidyverse</code> in R, <code>dplyr</code> is a package for data manipulation. It provides a set of functions that can be used to filter, select, arrange, mutate, summarize, and join data.</li>
<li><strong>dbplyr</strong> : Also a part of the <code>tidyverse</code> in R, <code>dbplyr</code> is a database backend for <code>dplyr</code>. It allows you to write R code that is then translated into SQL queries.</li>
</ul>
</section>
<section id="accessing-data" class="level2">
<h2 class="anchored" data-anchor-id="accessing-data">Accessing Data</h2>
<section id="connecting-to-the-database" class="level3">
<h3 class="anchored" data-anchor-id="connecting-to-the-database">Connecting to the database</h3>
<p>A connection to a database is an object that allows you to interact with it from R. The <code>allofus</code> package relies on the <code>bigrquery</code> R package to create a connection to the Google BigQuery database when you run <code>aou_connect()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(allofus)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">aou_connect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The object <code>con</code> is used to refer to the connection to the All of Us database. When you run the <code>aou_connect()</code> function, it also gets stored as the default connection for a session, so you don’t need to include it in other functions from the <code>allofus</code> package. For instance, you can run <code>aou_tables()</code> to see a list of tables in the database:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aou_tables</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>#&gt; # A tibble: 68 × 2
#&gt;    table_name               columns                                             
#&gt;    &lt;chr&gt;                    &lt;chr&gt;                                               
#&gt;  1 concept_ancestor         ancestor_concept_id, descendant_concept_id, min_lev…
#&gt;  2 cb_criteria_ancestor     ancestor_id, descendant_id                          
#&gt;  3 attribute_definition     attribute_definition_id, attribute_name, attribute_…
#&gt;  4 cdm_source               cdm_source_name, cdm_source_abbreviation, cdm_holde…
#&gt;  5 concept_class            concept_class_id, concept_class_name, concept_class…
#&gt;  6 concept                  concept_id, concept_name, domain_id, vocabulary_id,…
#&gt;  7 concept_synonym          concept_id, concept_synonym_name, language_concept_…
#&gt;  8 cb_criteria_relationship concept_id_1, concept_id_2                          
#&gt;  9 concept_relationship     concept_id_1, concept_id_2, relationship_id, valid_…
#&gt; 10 condition_occurrence     condition_occurrence_id, person_id, condition_conce…
#&gt; # ℹ 58 more rows</code></pre>
</div>
</section>
<section id="accessing-a-table" class="level3">
<h3 class="anchored" data-anchor-id="accessing-a-table">Accessing a table</h3>
<p>To access a table in the database, use <code>tbl(con, "tablename")</code>. The resulting object is reference to a table in a database that allows you to interact with it from R. In order to connect to a table in the database, you must first create the database connection (<code>con</code>). For example, to create a reference to the person table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>person_tbl <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"person"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Although the <code>person_tbl</code> object behaves similarly to a data frame, it is not actually a data frame. Instead, it is actually a SQL query that only gets run when you need to access the data. This is a feature of the <code>dbplyr</code> package that allows you to manipulate data without actually retrieving it. The SQL query behind the <code>person_tbl</code> object is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `person`</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When you print <code>person_tbl</code>, you’ll get something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>person_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>#&gt; # Source:   table&lt;person&gt; [?? x 23]
#&gt; # Database: BigQueryConnection
#&gt;    person_id gender_concept_id year_of_birth month_of_birth day_of_birth
#&gt;      &lt;int64&gt;           &lt;int64&gt;       &lt;int64&gt;        &lt;int64&gt;      &lt;int64&gt;
#&gt;  1   xxxxxxx            903096          1955             NA           NA
#&gt;  2   xxxxxxx            903096          1978             NA           NA
#&gt;  3   xxxxxxx            903096          2000             NA           NA
#&gt;  4   xxxxxxx            903096          1988             NA           NA
#&gt;  5   xxxxxxx            903096          1993             NA           NA
#&gt;  6   xxxxxxx            903096          1959             NA           NA
#&gt;  7   xxxxxxx            903096          1976             NA           NA
#&gt;  8   xxxxxxx            903096          1961             NA           NA
#&gt;  9   xxxxxxx            903096          1952             NA           NA
#&gt; 10   xxxxxxx            903096          1980             NA           NA
#&gt; # ℹ more rows
#&gt; # ℹ 18 more variables: birth_datetime &lt;dttm&gt;, race_concept_id &lt;int64&gt;,
#&gt; #   ethnicity_concept_id &lt;int64&gt;, location_id &lt;int64&gt;, provider_id &lt;int64&gt;,
#&gt; #   care_site_id &lt;int64&gt;, person_source_value &lt;chr&gt;, gender_source_value &lt;chr&gt;,
#&gt; #   gender_source_concept_id &lt;int64&gt;, race_source_value &lt;chr&gt;,
#&gt; #   race_source_concept_id &lt;int64&gt;, ethnicity_source_value &lt;chr&gt;,
#&gt; #   ethnicity_source_concept_id &lt;int64&gt;, …</code></pre>
<p>You’ll only see the first 10 rows of the person table (person ids were omitted from the output). This allows you to see what the data looks like without loading the entire table into R, which can be slow or even crash your session.</p>
<p>Instead, you want to perform as much data manipulation as possible on the database. This is more efficient because the operations are translated into SQL and executed on the server, which is faster and requires less memory than processing in R.</p>
</section>
</section>
<section id="data-manipulation-on-the-database" class="level2">
<h2 class="anchored" data-anchor-id="data-manipulation-on-the-database">Data manipulation on the database</h2>
<p>Before bringing data into R, you can manipulate it on the database using the <code>dplyr</code> functions. This allows you to perform operations on the database without bringing the data into R’s memory.</p>
<p>For example, you can subset the person table to women born after 1980:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>young_women <span class="ot">&lt;-</span> person_tbl <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gender_concept_id <span class="sc">==</span> <span class="dv">45878463</span>, year_of_birth <span class="sc">&gt;</span> <span class="dv">1980</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before we print out <code>young_women</code>, the SQL query has not actually been run. In fact, <code>person_tbl</code> is not run either. When we do print it, it will run the following SQL:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> `person`.<span class="op">*</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `person`</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> (`gender_concept_id` <span class="op">=</span> <span class="fl">45878463.0</span>) <span class="kw">AND</span> (`year_of_birth` <span class="op">&gt;</span> <span class="fl">1980.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and print the first 10 rows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>young_women</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>#&gt; # Source:   SQL [?? x 23]
#&gt; # Database: BigQueryConnection
#&gt;    person_id gender_concept_id year_of_birth month_of_birth day_of_birth
#&gt;      &lt;int64&gt;           &lt;int64&gt;       &lt;int64&gt;        &lt;int64&gt;      &lt;int64&gt;
#&gt;  1   xxxxxxx          45878463          1992             NA           NA
#&gt;  2   xxxxxxx          45878463          1989             NA           NA
#&gt;  3   xxxxxxx          45878463          1981             NA           NA
#&gt;  4   xxxxxxx          45878463          1990             NA           NA
#&gt;  5   xxxxxxx          45878463          1990             NA           NA
#&gt;  6   xxxxxxx          45878463          1985             NA           NA
#&gt;  7   xxxxxxx          45878463          1987             NA           NA
#&gt;  8   xxxxxxx          45878463          1986             NA           NA
#&gt;  9   xxxxxxx          45878463          1983             NA           NA
#&gt; 10   xxxxxxx          45878463          1998             NA           NA
# ℹ more rows
# ℹ 18 more variables: birth_datetime &lt;dttm&gt;, race_concept_id &lt;int64&gt;,
#   ethnicity_concept_id &lt;int64&gt;, location_id &lt;int64&gt;, provider_id &lt;int64&gt;,
#   care_site_id &lt;int64&gt;, person_source_value &lt;chr&gt;, gender_source_value &lt;chr&gt;,
#   gender_source_concept_id &lt;int64&gt;, race_source_value &lt;chr&gt;,
#   race_source_concept_id &lt;int64&gt;, ethnicity_source_value &lt;chr&gt;,
#   ethnicity_source_concept_id &lt;int64&gt;, …</code></pre>
<p>Note that we don’t know how many observations match these conditions yet (the dimensions are <code>[?? x 23]</code>), because it hasn’t been fully executed – only the first 10 rows. To get the total number of observations, we can use <code>tally()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tally</span>(young_women)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>#&gt; # Source:   SQL [1 x 1]
#&gt; # Database: BigQueryConnection
#&gt;         n
#&gt;   &lt;int64&gt;
#&gt; 1   76135</code></pre>
<p>This is actually a SQL query that only results in 1 row, so we do get to see the entire thing. It’s much faster to run than to bring the entire table into R and then count the number of rows, because the code is executed on the database:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> `n`</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> `person`.<span class="op">*</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> `person`</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> (`gender_concept_id` <span class="op">=</span> <span class="fl">45878463.0</span>) <span class="kw">AND</span> (`year_of_birth` <span class="op">&gt;</span> <span class="fl">1980.0</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="the-collect-function" class="level3">
<h3 class="anchored" data-anchor-id="the-collect-function">The <code>collect()</code> Function</h3>
<p>We can bring the result of a query into the local R session using <code>collect()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>young_women <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This brings the table into your local R workspace as a tibble, or dataframe. This is useful for performing operations that cannot be performed directly on the database, such as certain statistical analyses or plotting. For example, if you’re planning to run a regression analysis on the filtered data, you would first use <code>collect()</code> to bring the data into R.</p>
<p>We can bring in the result of <code>tally()</code> as well:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tally</span>(young_women) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>#&gt; A tibble: 1 × 1
#&gt;       n
#&gt; &lt;int64&gt;
#&gt;   76135</code></pre>
<p>Or even the entire person table, although that’s not recommended because it’s so large!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>person_data <span class="ot">&lt;-</span> person_tbl <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>person_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>#&gt; # A tibble: 413457 × 23
#&gt; person_id    gender_concept_id   year_of_birth   month_of_birth  day_of_birth    
#&gt;   &lt;int64&gt;              &lt;int64&gt;         &lt;int64&gt;          &lt;int64&gt;       &lt;int64&gt;
#&gt;   xxxxxxx               903096            1955               NA            NA    
#&gt;   xxxxxxx               903096            1978               NA            NA
#&gt;   xxxxxxx               903096            2000               NA            NA
#&gt;   xxxxxxx               903096            1988               NA            NA
#&gt;   xxxxxxx               903096            1993               NA            NA
#&gt;   xxxxxxx               903096            1959               NA            NA
#&gt;   xxxxxxx               903096            1976               NA            NA
#&gt;   xxxxxxx               903096            1961               NA            NA
#&gt;   xxxxxxx               903096            1952               NA            NA
#&gt;   xxxxxxx               903096            1980               NA            NA    </code></pre>
</section>
</section>
<section id="data-manipulation-with-multiple-tables" class="level2">
<h2 class="anchored" data-anchor-id="data-manipulation-with-multiple-tables">Data manipulation with multiple tables</h2>
<p>The All of Us data is spread across multiple tables, for the most part corresponding to the OMOP Common Data Model. This allows for efficient storage and retrieval of data, but it can be a bit tricky to work with at first. Fortunately, <code>dbplyr</code> makes it easy to join tables together.</p>
<p>For example, how did we know that <code>gender_concept_id == 45878463</code> referred to women? We can look up the names of concept ids in the <code>concept</code> table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>concept_tbl <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"concept"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(concept_id, concept_name)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>concept_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>#&gt; # Source:   SQL [?? x 2]
#&gt; # Database: BigQueryConnection
#&gt;    concept_id concept_name                                      
#&gt;       &lt;int64&gt; &lt;chr&gt;                                             
#&gt;  1   38003166 Durable Medical Equipment - General Classification
#&gt;  2   35805830 DexaBEAM                                          
#&gt;  3   38003221 Blood - Plasma                                    
#&gt;  4    1147839 survey_conduct.survey_start_date                  
#&gt;  5       8623 log reduction                                     
#&gt;  6   38004063 Rehabilitation Practitioner                       
#&gt;  7   38003186 Radiology - Diagnostic - General Classification   
#&gt;  8   35805115 VNCOP-B                                           
#&gt;  9   35805457 VAdCA                                             
#&gt; 10       8581 heartbeat                                         
#&gt; # ℹ more rows</code></pre>
<p>We just want to extract the names of the gender concept ids. To do this, we can join the <code>person</code> table with the <code>concept</code> table. So that we can see the full range of gender ids, first we will count them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>genders_in_aou <span class="ot">&lt;-</span> person_tbl <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(gender_concept_id) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(concept_tbl, <span class="at">by =</span> <span class="fu">join_by</span>(gender_concept_id <span class="sc">==</span> concept_id))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>genders_in_aou</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>#&gt; # Source:   SQL [9 x 3]
#&gt; # Database: BigQueryConnection
#&gt;   gender_concept_id       n concept_name                                        
#&gt;             &lt;int64&gt; &lt;int64&gt; &lt;chr&gt;                                               
#&gt; 1           1177221     602 I prefer not to answer                              
#&gt; 2                 0      97 No matching concept                                 
#&gt; 3          45878463  247453 Female                                              
#&gt; 4           1585843     407 Gender Identity: Additional Options                 
#&gt; 5            903096    7356 PMI: Skip                                           
#&gt; 6          45880669  154241 Male                                                
#&gt; 7           1585842     562 Gender Identity: Transgender                        
#&gt; 8           1585841    1213 Gender Identity: Non Binary                         
#&gt; 9        2000000002    1526 Not man only, not woman only, prefer not to answer,…</code></pre>
<p>The result of this SQL query is just 9 rows, so we get to see all of them. Both the counting and the joining were done directly on the database, so this was very efficient.</p>
<section id="aou_join" class="level3">
<h3 class="anchored" data-anchor-id="aou_join"><code>aou_join()</code></h3>
<p>The <code>allofus</code> package includes a function called <code>aou_join()</code> that makes it easy to join tables together. It includes some additional checks to help avoid mistakes in joining. For example, if we wanted to join the <code>person</code> table with the <code>observation</code> table, dropping people with no observations, we could do it like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> person_tbl <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aou_join</span>(<span class="st">"observation"</span>, <span class="at">type =</span> <span class="st">"inner"</span>, <span class="at">by =</span> <span class="st">"person_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Warning message:
“There are shared column names not specified in the `by` argument.
→ These column names now end in '_x' and '_y'.
ℹ You can change these suffixes using the `suffix` argument but it cannot
  contain periods (`.`).
→ Consider specifing all shared columns in the `by` argument.
→ Or if these additional shared columns are `NA`, remove them prior to joining.”</code></pre>
<p>The warning message tells us that the <code>person</code> and <code>observation</code> tables share some column names that we didn’t specify as part of the join argument. That is because both tables have a column called <code>provider_id</code>. We can see this by looking at the column names of the <code>obs</code> table that have the default added suffix, “_x” and “_y”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>obs <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">"_x"</span>), <span class="fu">ends_with</span>(<span class="st">"_y"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>#&gt; [1] "provider_id_x" "provider_id_y"</code></pre>
</div>
<p>Because this is often a mistake occurring because we are not working with the tables directly, <code>aou_join()</code> warns us about this. We can avoid this warning by specifying all of the columns that we want to join on and removing the columns that we don’t want to join on. For example, we could remove the <code>provider_id</code> column from the <code>person</code> table before joining:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> person_tbl <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>provider_id) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aou_join</span>(<span class="st">"observation"</span>, <span class="at">type =</span> <span class="st">"inner"</span>, <span class="at">by =</span> <span class="st">"person_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="joins-from-different-sources" class="level2">
<h2 class="anchored" data-anchor-id="joins-from-different-sources">Joins from different sources?</h2>
<p>Unfortunately, we can’t join a table on the database with a dataframe in R. If you end up with one of each, you have a couple of options:</p>
<ol type="1">
<li>See if you can avoid collecting the dataframe into R. Most <code>allofus</code> functions have a <code>collect = FALSE</code> argument, but sometimes it’s unavoidable.</li>
<li>Bring the table from the database into R using <code>collect()</code> and then join it with the dataframe in R. This can be inefficient if part of the reason for joining is to subset the table down to only data you care about.</li>
<li>First subset the table on the database, then bring it into R and join it with the dataframe in R. For example, if you have a cohort of participants as a dataframe, e.g., as created by <code>aou_atlas_cohort()</code>, and you want to bring in activity data for those participants, you could run:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># instead of aou_join(cohort, "activity_summary", type = "left", by = "person_id")</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>activity_data <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"activity_summary"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(person_id <span class="sc">%in%</span> <span class="sc">!!</span>cohort<span class="sc">$</span>person_id) <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(cohort, <span class="at">by =</span> <span class="st">"person_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="viewing-the-underlying-sql-with-show_query" class="level2">
<h2 class="anchored" data-anchor-id="viewing-the-underlying-sql-with-show_query">Viewing the Underlying SQL with <code>show_query()</code></h2>
<p>Understanding the SQL code that <code>dbplyr</code> generates can be insightful, especially if you’re debugging or simply curious about the translation from R to SQL. To view the SQL query that corresponds to your <code>dbplyr</code> operations, use the <code>show_query()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>obs <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>SELECT
  `edjnngldox`.`person_id` AS `person_id`,
  `gender_concept_id`,
  `year_of_birth`,
  `month_of_birth`,
  `day_of_birth`,
  `birth_datetime`,
  `race_concept_id`,
  `ethnicity_concept_id`,
  `location_id`,
  `care_site_id`,
  `person_source_value`,
  `gender_source_value`,
  `gender_source_concept_id`,
  `race_source_value`,
  `race_source_concept_id`,
  `ethnicity_source_value`,
  `ethnicity_source_concept_id`,
  `state_of_residence_concept_id`,
  `state_of_residence_source_value`,
  `sex_at_birth_concept_id`,
  `sex_at_birth_source_concept_id`,
  `sex_at_birth_source_value`,
  `observation_id`,
  `observation_concept_id`,
  `observation_date`,
  `observation_datetime`,
  `observation_type_concept_id`,
  `value_as_number`,
  `value_as_string`,
  `value_as_concept_id`,
  `qualifier_concept_id`,
  `unit_concept_id`,
  `zwcwezaowf`.`provider_id` AS `provider_id`,
  `visit_occurrence_id`,
  `visit_detail_id`,
  `observation_source_value`,
  `observation_source_concept_id`,
  `unit_source_value`,
  `qualifier_source_value`,
  `value_source_concept_id`,
  `value_source_value`,
  `questionnaire_response_id`
FROM `person` `edjnngldox`
INNER JOIN `observation` `zwcwezaowf`
  ON (`edjnngldox`.`person_id` = `zwcwezaowf`.`person_id`)</code></pre>
<p>This function prints the SQL query that would be sent to the database. It’s a great way to learn SQL and understand how <code>dbplyr</code> optimizes data manipulation. (Why the gibberish table names? Bugs in previous versions of <code>dbplyr</code> resulted in table names that would break the query, and giving them unique names is a workaround.)</p>
</section>
<section id="running-sql-code-directly" class="level2">
<h2 class="anchored" data-anchor-id="running-sql-code-directly">Running SQL code directly</h2>
<p>Another approach to working with the data is to write SQL code directly. This is especially useful for complex queries that are difficult to express in <code>dplyr</code> syntax. The <code>allofus</code> package includes a function called <code>aou_sql()</code> that makes it easy to run SQL code directly on the database. For example, we could count the number of people in the <code>person</code> table like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aou_sql</span>(<span class="st">"SELECT COUNT(*) AS n FROM {CDR}.person"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are a few important things to note about this code. First, the <code>CDR</code> variable is a special variable referring to what All of Us calls the “curated data repository”. When writing SQL code directly, we don’t need the database connection object <code>con</code>, instead we need to direct the code to the correct tables by preceding the table names with “{CDR}”. This means we can’t run the code we get from <code>show_query()</code> without modification. For example, we could count the number of young women in the dataset, as we did above with the <code>dbplyr</code> approach, like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aou_sql</span>(<span class="st">"</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT count(*) AS `n`</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="st">FROM (</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT `person`.*</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM {CDR}.`person`</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE (`gender_concept_id` = 45878463.0) AND (`year_of_birth` &gt; 1980.0)</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Second, the <code>aou_sql()</code> function returns a dataframe – the entire result of the SQL query is brought into memory. This means that we want to run an entire query at once, instead of breaking it into multiple steps like we did with <code>dbplyr</code>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
  </div>
  <div class="nav-page nav-page-next">
      <a href="../vignettes/atlas.html" class="pagination-link" aria-label="Using ATLAS to create a cohort">
        <span class="nav-page-text">Using ATLAS to create a cohort</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><code>allofus</code> R package version 1.1.0</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>